/*! habit-trainer 13-10-2015 */
angular.module("starter",["ionic","starter.controllers","starter.services","ngRoute","ngSanitize","gridshore.c3js.chart","satellizer","cgNotify"]).run(["$ionicPlatform","$rootScope","$location","$interval","Auth","Events","Habits",function(a,b,c,d,e,f,g){a.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleDefault(),("undefined"==typeof google||void 0===typeof google)&&console.log("Google maps unavailable"),b.$on("$routeChangeStart",function(a,b,d){b.$$route&&b.$$route.authenticate&&!e.isAuth()&&c.path("/signin")});var a,h=function(){console.log("eventScheduler start"),g.getHabits().then(function(b){events=f.getEventQueue(b),a=d(function(){events.length&&f.triggerEvents(events)},1e3)})};h(),b.$on("habitChange",h)})}]).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}).directive("d3Bars",["$window","$timeout",function(a,b){return{restrict:"EA",scope:{data:"=",label:"@",onClick:"&"},link:function(c,d,e){var f,g=parseInt(e.margin)||0,h=parseInt(e.barHeight)||40,i=parseInt(e.barPadding)||10,j=d3.select(d[0]).append("svg").style("width","100%");a.onresize=function(){c.$apply()},c.$watch(function(){return angular.element(a)[0].innerWidth},function(){c.render(c.data)}),c.$watch("data",function(a){c.render(a)},!0),c.render=function(a){j.selectAll("*").remove(),a&&(f&&clearTimeout(f),f=b(function(){var b=d3.select(d[0])[0][0].offsetWidth-g,e=c.data.length*(h+i),f=d3.scale.category10(),k=d3.scale.linear().domain([0,d3.max(a,function(a){return a.streak})]).range([0,b]);j.attr("height",e),j.selectAll("rect").data(a).enter().append("rect").on("click",function(a,b){return c.onClick({item:a})}).attr("height",h).attr("width",140).attr("x",Math.round(g/2)).attr("y",function(a,b){return b*(h+i)}).attr("fill",function(a){return f("#1f77b4")}).transition().duration(1e3).attr("width",function(a){return k(a.streak)}),j.selectAll("text").data(a).enter().append("text").attr("fill","#fff").attr("y",function(a,b){return b*(h+i)+25}).attr("x",15).text(function(a){return a.habitName+" (streak: "+a.streak+")"})},200))}}}}]).factory("AttachTokens",["$window",function(a){return{request:function(b){var c=a.localStorage.getItem("habit_token");return c&&(b.headers.Authorization="Bearer "+c),b.headers["Allow-Control-Allow-Origin"]="*",b}}}]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$authProvider",function(a,b,c,d){a.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AuthCtrl"}).state("app.signup",{url:"/signup",views:{menuContent:{templateUrl:"templates/signup.html",controller:"AuthCtrl"}}}).state("app.dashboard",{url:"/dashboard",views:{menuContent:{templateUrl:"templates/dashboard.html",controller:"DashboardCtrl"}},authenticate:!0}).state("app.create",{url:"/create",views:{menuContent:{templateUrl:"templates/create.html",controller:"CreateCtrl"}},authenticate:!0}).state("app.edit",{url:"/edit",views:{menuContent:{templateUrl:"templates/edit.html",controller:"EditCtrl"}},authenticate:!0}).state("app.register",{url:"/register",views:{menuContent:{templateUrl:"templates/register.html",controller:"RegisterCtrl"}}}).state("app.history",{url:"/history",views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryCtrl"}}}).state("app.listing",{url:"/listing",views:{menuContent:{templateUrl:"templates/listing.html",controller:"ListingCtrl"}}}).state("app.searches",{url:"/search",views:{menuContent:{templateUrl:"templates/search.html",controller:"SearchResultsCtrl"}}}).state("app.profile",{url:"/profile",views:{menuContent:{templateUrl:"templates/profile.html",controller:"ProfileCtrl"}}}),b.otherwise("/app/dashboard"),d.loginUrl="/signin",d.signupUrl="/signup",d.tokenPrefix="habit",d.google({clientId:"416143587162-phs72qq27pfvqua6buqb5lf4okum9krq.apps.googleusercontent.com",url:"/authenticate/google"}),c.interceptors.push("AttachTokens")}]),angular.module("starter.controllers",["starter.services"]).controller("AppCtrl",["Login","$scope","$ionicModal","$timeout",function(a,b,c,d){b.loginData={},c.fromTemplateUrl("templates/signin.html",{scope:b}).then(function(a){b.modal=a}),b.closeLogin=function(){b.modal.hide()},b.login=function(){b.modal.show()},b.doLogin=function(){console.log("Browser Console - Logging in with ",b.loginData),a.signIn(b.loginData),d(function(){b.closeLogin()},1e3)}}]).controller("AuthCtrl",["$rootScope","$scope","$window","$location","Auth","$auth","$ionicModal","$timeout",function(a,b,c,d,e,f,g,h){a.showNav=!1,b.user={},g.fromTemplateUrl("templates/signin.html",{scope:b}).then(function(a){b.modal=a}),b.authenticate=function(a){f.authenticate(a).then(function(){d.path("/")})["catch"](function(a){b.alert=a.data.message})},b.closeLogin=function(){b.modal.hide()},b.login=function(){b.modal.show()},b.signin=function(){e.signin(b.user).then(function(a){c.localStorage.setItem("habit_token",a),d.path("/dashboard")})["catch"](function(a){b.alert=a.data.message})},b.signup=function(){e.signup(b.user).then(function(a){c.localStorage.setItem("habit_token",a),d.path("/dashboard")})["catch"](function(a){b.alert=a.data.message})},"/signout"===d.path()&&e.signout()}]).controller("RegisterCtrl",["Register","$scope","$timeout","$location",function(a,b,c,d){b.registerData={},b.doRegister=function(){console.log("Browser Console - Registering in with ",b.registerData),a.registerIn(b.registerData),c(function(){d.path("#/app/search")},1e3)}}]).controller("SearchResultsCtrl",["$scope","$location","Search",function(a,b,c){a.searches=[{id:1,address:"1600 Amphitheatre Pkwy, Mountain View, CA",seller:"Joe",price:10,lat:37.422245,lng:-122.0840084},{id:2,address:"1 World Way, Los Angeles, CA",seller:"John",price:15,lat:33.94224,lng:-118.40279},{id:3,address:"652 Polk St San Francisco, CA",seller:"Katherine",price:20,lat:37.78291,lng:-122.41902},{id:4,address:"Dick's Sporting Goods Concord, NH 03301 United States",seller:"Christina",price:25,lat:43.22697,lng:-71.48562},{id:5,address:"Highland Middle School, 15027 Bel-Red Rd Bellevue, WA 98007, United States",seller:"Bob",price:30,lat:47.62657,lng:-122.1402},{id:6,address:"582 Sutter St San Francisco, CA 94102",seller:"Bob",price:30,lat:37.78918,lng:-122.40993},{id:7,address:"678 Post St San Francisco, CA 94109",seller:"Bob",price:30,lat:37.78776,lng:-122.41295},{id:8,address:"850 Bush St San Francisco, CA 94108",seller:"Bob",price:30,lat:37.79003,lng:-122.41134},{id:9,address:"144 Taylor St San Francisco, CA 94102",seller:"Bob",price:30,lat:37.78391,lng:-122.41067},{id:10,address:"912 Sutter St San Francisco, CA 94104",seller:"Bob",price:30,lat:37.78854,lng:-122.41548},{id:11,address:"754 Post St San Fran cisco, CA 94109",seller:"Bob",price:30,lat:37.78778,lng:-122.41436},{id:12,address:"670 Larkin St San Francisco, CA 94109",seller:"Bob",price:30,lat:37.78407,lng:-122.41759},{id:13,address:"798 Sutter St San Francisco, CA 94109",seller:"Bob",price:30,lat:37.78878,lng:-122.41347},{id:14,address:"871 Sutter St San Francisco, CA 94109",seller:"Bob",price:30,lat:37.78823,lng:-122.41459},{id:15,address:"619 Taylor St San Francisco, CA 94102",seller:"Bob",price:30,lat:37.7882,lng:-122.41204}];var d,e=[],f=null;a.getSearches=function(b){a.AddressToLocation(b,function(b){var c={zoom:19,center:b};d=new google.maps.Map(document.getElementById("map"),c),google.maps.event.addListener(d,"idle",a.showMarkers),a.addMarkerGeo(b,d)})},a.showMarkers=function(){var b=d.getBounds(),c=a.searches.filter(function(a){var c=a.lat<b.Ka.j&&a.lat>b.Ka.H&&a.lng<b.Ga.H&&a.lng>b.Ga.j;return c});a.clearMarkers(),c.forEach(function(b){e.push(a.addMarker(b,d))})},a.clearMarkers=function(){for(var a=0;a<e.length;a++)e[a].setMap(null);e=[]},a.addMarkerGeo=function(a,b){var c=new google.maps.Marker({map:b,position:a,icon:"./../img/green-dot.png",mapTypeId:google.maps.MapTypeId.ROADMAP});return c},a.AddressToLocation=function(a,b){var c=new google.maps.Geocoder;c.geocode({address:a},function(a,c){c===google.maps.GeocoderStatus.OK?b(a[0].geometry.location):alert("Geocode was not successful for the following reason: "+c)})},a.addMarker=function(b,c){var d=new google.maps.Marker({map:c,position:new google.maps.LatLng(b.lat,b.lng),mapTypeId:google.maps.MapTypeId.ROADMAP});return a.addInfoWindow(b,d),d},a.addInfoWindow=function(a,b){var c="<div>Address: "+a.address+"</div><div>Seller: "+a.seller+"</div><button>Book the space!!!</button>",e=new google.maps.InfoWindow({content:c});b.addListener("click",function(){f&&f.close(),f=e,f.open(d,b)})}}]).controller("MapController",["$scope","$ionicLoading",function(a,b){a.initialise=function(){var b,c=new google.maps.LatLng(37.3,-120.4833),d={center:c,zoom:19,mapTypeId:google.maps.MapTypeId.ROADMAP},e=new google.maps.Map(document.getElementById("map"),d);navigator.geolocation.getCurrentPosition(function(a){console.log(a),e.setCenter(new google.maps.LatLng(a.coords.latitude,a.coords.longitude));new google.maps.Marker({position:new google.maps.LatLng(a.coords.latitude,a.coords.longitude),map:e,title:"My Location"})}),a.map=e,google.maps.event.addListener(e,"click",function(a){b&&b.setMap(null),b=new google.maps.Marker({position:a.latLng,map:e})})},google.maps.event.addDomListener(document.getElementById("map"),"load",a.initialise())}]).controller("ListingCtrl",["Listing","$scope","$ionicModal",function(a,b,c){b.listings=[],c.fromTemplateUrl("templates/addListingModal.html",{scope:b,animation:"slide-in-up",focusFirstInput:!0}).then(function(a){b.modal=a}),b.openModal=function(){b.modal.show()},b.closeModal=function(){b.modal.hide()},b.$on("$destroy",function(){b.modal.remove()}),b.addListing=function(c){console.log("data is: ",c);var d={address:c.address,startDate:new Date(c.startDate),endDate:new Date(c.endDate),startTime:c.startTime,endTime:c.endTime,startHours:new Date(c.startTime).getUTCHours(),startMinutes:new Date(c.startTime).getUTCMinutes(),endHours:new Date(c.endTime).getUTCHours(),endMinutes:new Date(c.endTime).getUTCMinutes(),price:c.price};a.addListing(d),b.listings.push(d),c.address=null,c.startDate=null,c.endDate=null,c.startTime=null,c.endTime=null,c.price=0,b.closeModal()}}]).controller("HistoryCtrl",["Login","Historie","$scope","$location",function(a,b,c,d){c.histories=b.query()}]).controller("ProfileCtrl",["$scope","$timeout","$location",function(a,b,c){a.profileInfo=[{firstName:"bob",lastName:"Amory",emailAddress:"bobAmory@gmail.com",physicalAddress:"123 Fake Street, USA",phoneNumber:"123-456-7890",username:"bobAmory"}],a.profileChangeInfo={},a.doProfileChange=function(){console.log("Browser Console - Registering in with ",a.profileChangeInfo),a.profileChangeInfo={},b(function(){c.path("#/app/search")},1e3)}}]).controller("EditCtrl",["$rootScope","$scope","$location","Habits",function(a,b,c,d){a.showNav=!0,b.habit=d.getEdit(),b.updateHabit=function(){d.updateHabit(b.habit).then(function(){a.$broadcast("habitChange"),c.path("/dashboard")})["catch"](function(a){console.error(a)})},b.deactivateHabit=function(){b.habit.active=!1,d.updateHabit(b.habit).then(function(){a.$broadcast("habitChange"),c.path("/dashboard")})["catch"](function(a){console.error(a)})}}]).controller("DashboardCtrl",["$rootScope","$scope","$location","Habits","Events",function(a,b,c,d,e){a.showNav=!0,b.testHabits=[{habitName:"Submit a Pull Request",streak:5,checkinCount:25,failedCount:3,reminderTime:"2:30 PM",dueTime:"4:30 PM",streakRecord:15,active:!0},{habitName:"Complete a Pomodoro",streak:10,checkinCount:20,failedCount:4,reminderTime:"2:30 PM",dueTime:"4:30 PM",streakRecord:20,active:!0},{habitName:"Workout",streak:8,checkinCount:15,failedCount:2,reminderTime:"2:30 PM",dueTime:"4:30 PM",streakRecord:8,active:!0}],b.colors=["#1f77b4","#ff7f0e","#2ca02c"],b.buttonState=function(a,b){return"pending"===b?"pending"===a.status||"remind"===a.status||"reminded"===a.status:"completed"===b?"completed"===a.status:"failed"===b?"failed"===a.status||"missed"===a.status:void 0},b.getHabits=function(){d.getHabits().then(function(c){b.habits=a.sample?b.testHabits:c,b.habits=b.habits.filter(function(a){return a.active}),b.habitStreaks=b.habits.filter(function(a){return a.streak>0}),b.totalFailed=b.habits.reduce(function(a,b){return console.log("failedCount:",b.failedCount),a+b.failedCount},0),b.totalCompleted=0,b.habitsCompleted=b.habits.map(function(a){return b.totalCompleted+=a.checkinCount,a.completed}),b.score=Math.round(b.totalCompleted/(b.totalCompleted+b.totalFailed)*100),console.log("completed:",b.totalCompleted),console.log("failed:",b.totalFailed),console.log("score:",b.score)})["catch"](function(a){console.error(a)})},b.getHabits(),b.toggleSampleData=function(){a.sample=!a.sample,c.path("/")},b.formatDonut=function(a){return a},b.editHabit=function(a){d.setEdit(a),c.path("/edit")},b.checkinHabit=function(a){d.checkinHabit(a).then(function(){b.getHabits(),c.path("/")})["catch"](function(a){console.error(a)})}}]).controller("CreateCtrl",["$rootScope","$scope","$location","Habits",function(a,b,c,d){a.showNav=!0,b.habit={},d.getHabits().then(function(a){var c=0;a.forEach(function(a){c+=a.active?1:0}),3>c?(b.showCreate=!0,b.showLimitExceed=!1):(b.showCreate=!1,b.showLimitExceed=!0)})["catch"](function(a){console.error(a)}),b.addHabit=function(){d.addHabit(b.habit).then(function(){a.$broadcast("habitChange"),c.path("/dashboard")})["catch"](function(a){console.error(a)})}}]),angular.module("starter.services",["ngResource"]).factory("Search",["$resource",function(a){return a("http://localhost:5000/search/:searchId")}]).factory("Historie",["$resource",function(a){return a("/api/history/:historyId")}]).factory("Auth",function(a,b,c,d,e){var f=function(b){return b.username=e(b.username),b.password=e(b.password),a.post("/authenticate/signin",b).then(function(a){return a.data.token})},g=function(b){return b.username=e(b.username),b.password=e(b.password),a.post("/authenticate/signup",b).then(function(a){return a.data.token})},h=function(){return!!c.localStorage.getItem("habit_token")},i=function(){d.logout().then(function(){b.path("/signin")})};return{signin:f,signup:g,isAuth:h,signout:i}}).factory("Register",["$http",function(a){var b=null;return{registerIn:function(b){return a({method:"POST",url:"/api/register",data:b}).then(function(a){return console.log(a),a.data.token})},userID:b}}]).factory("Listing",["$http",function(a){return{getListings:function(){return a({method:"GET",url:"/api/listing"}).then(function(a){return console.log(a.data),a.data})},addListing:function(b){return console.log("iminaddlisting"),a({method:"POST",url:"/api/listing",data:b}).then(function(a){return console.log(a),a.data.token})}}}]).factory("Profile",["$resource",function(a){return a("http://localhost:5000/profile/:profileId")}]).factory("Habits",function(a,b,c,d){var e={},f={};return f.getHabits=function(){return a({method:"GET",url:"/api/users/habits"}).then(function(a){return a.data.habits})},f.addHabit=function(c){return c.habitName=b(c.habitName),a({method:"POST",url:"/api/users/habits",data:c})},f.setEdit=function(a){e=a,e.reminderTime=new Date(e.reminderTime),e.dueTime=new Date(e.dueTime)},f.getEdit=function(a){return e},f.updateHabit=function(b){return a({method:"PUT",url:"/api/users/habits/"+b._id,data:b})},f.statusChange=function(b){var d=c(b.message);d({habitName:b.habit.habitName,eventTime:b.eventTime});return a({method:"PUT",url:"/api/users/habits/"+b.eventName+"/"+b.habit._id,data:b.habit})},f.checkinHabit=function(b){return d("Great job completing your habit!"),a({method:"POST",url:"/api/records/"+b._id,data:b})},f}).factory("Events",function(a){var b={reminded:'Reminder: {{habitName}} is due at {{eventTime | date: "shortTime"}}!',failed:'Habit failed!  You did not complete {{habitName}} by the due time of {{eventTime | date: "shortTime"}}!'},c=function(a,c,d){this.habit=a,this.eventName=c,this.eventTime=d,this.message=b[c]},d=function(b){return b.reduce(function(b,d){var e=new c(d,"failed",d.dueTime),f=new c(d,"reminded",d.reminderTime);return"missed"===d.status?(a.statusChange(e),b):"remind"===d.status?(a.statusChange(f),b.concat(f)):"pending"===d.status?b.concat(f,e):b},[]).sort(function(a,b){return a.eventTime-b.eventTime})},e=function(b){if(b.length){var c=new Date,d=60*c.getHours()+c.getMinutes(),f=new Date(b[0].eventTime),g=60*f.getHours()+f.getMinutes();if(d>=g){var h=b.shift();a.statusChange(h).then(function(){e(b)})}}};return{getEventQueue:d,triggerEvents:e}});